(()=>{"use strict";const t={encryptedAccessToken:void 0,encryptedRefreshToken:void 0,tokenStorageVersion:void 0,machineId:void 0,deviceId:void 0,accessToken:void 0,refreshToken:void 0,tokenExpiresAt:0,userEmail:"",userId:null,isSubscribed:!1,subscriptionPlan:null,autoPaste:!0,showNotifications:!0,showFloatingWidget:!0,typingSpeed:"instant",historyRetentionDays:30,hasShownWelcome:!1,hasGivenPrivacyConsent:!1,pendingTranscriptions:[],history:[]};let e=null;async function n(n){const i=await async function(){if(e)return{...e};const n=await chrome.storage.local.get("settings"),i={...t,...n.settings||{}};return e=i,i}();e={...i,...n},await chrome.storage.local.set({settings:e}),e=null}async function i(){const e=await chrome.storage.local.get("settings");return{...t,...e.settings||{}}.history||[]}async function o(t){const e=(await i()).filter(e=>e.id!==t);await n({history:e})}const s={searchInput:document.getElementById("search-input"),historyList:document.getElementById("history-list"),container:document.querySelector(".sidepanel-container"),headerStats:document.getElementById("header-stats")};let a=[],r="",c=50;let d=null,l=null,u=null;async function h(){a=await i(),m(),y()}function m(){const t=a.length,e=a.reduce((t,e)=>t+(e.wordCount||0),0);s.headerStats.innerHTML=`\n\t\t<div><span class="stat-value">${t}</span> notes</div>\n\t\t<div><span class="stat-value">${e}</span> words</div>\n\t`}function y(){const t=r?a.filter(t=>t.text.toLowerCase().includes(r)):a;if(0===t.length)return void(s.historyList.innerHTML=r?'<p class="empty-state">No results found</p>':'<p class="empty-state">No transcriptions yet</p>');const e=t.slice(0,c),n=c<t.length;s.historyList.innerHTML=e.map(t=>`\n\t\t<div class="history-item" data-id="${t.id}">\n\t\t\t<div class="history-header">\n\t\t\t\t<span class="history-time">${function(t){const e=Date.now()-t,n=Math.floor(e/1e3),i=Math.floor(n/60),o=Math.floor(i/60),s=Math.floor(o/24);return n<60?"just now":i<60?1===i?"1m ago":`${i}m ago`:o<24?1===o?"1h ago":`${o}h ago`:s<7?1===s?"1d ago":`${s}d ago`:new Date(t).toLocaleDateString("en-US",{month:"short",day:"numeric"})}(t.timestamp)}</span>\n\t\t\t\t<div class="history-meta-right">\n\t\t\t\t\t<span class="history-meta">${v(t.duration,t.wordCount)} · ${t.wordCount} words</span>\n\t\t\t\t\t<button class="delete-btn" data-id="${t.id}" title="Delete">×</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="history-text">${function(t,e){const n=function(t,e){const n=120;if(!e)return t.length>n?t.slice(0,n)+"...":t;const i=e.toLowerCase(),o=t.toLowerCase().indexOf(i);if(-1===o)return t.length>n?t.slice(0,n)+"...":t;if(o<n)return t.length>n?t.slice(0,n)+"...":t;const s=Math.max(0,o-50),a=Math.min(t.length,o+e.length+50);let r="";return s>0&&(r+="..."),r+=t.slice(s,a),a<t.length&&(r+="..."),r}(t,e);if(!e)return g(n);const i=g(n),o=e.toLowerCase(),s=i.toLowerCase();let a="",r=0,c=s.indexOf(o);for(;-1!==c;)a+=i.slice(r,c),a+=`<mark class="search-highlight">${i.slice(c,c+e.length)}</mark>`,r=c+e.length,c=s.indexOf(o,r);return a+=i.slice(r),a}(t.text,r)}</div>\n\t\t</div>\n\t`).join("")+(n?'<div class="load-more-indicator">Scroll for more...</div>':""),s.historyList.querySelectorAll(".history-item").forEach(t=>{t.addEventListener("click",async e=>{if(e.target.classList.contains("delete-btn"))return;const n=t.getAttribute("data-id"),i=a.find(t=>t.id===n);i&&(await navigator.clipboard.writeText(i.text),p(t))}),t.addEventListener("contextmenu",e=>{const n=t.getAttribute("data-id");n&&function(t,e){if(t.preventDefault(),!d)return;l=e,d.style.display="block";let n=t.clientX,i=t.clientY;n+150>window.innerWidth&&(n=window.innerWidth-150-10),i+80>window.innerHeight&&(i=window.innerHeight-80-10),d.style.left=`${n}px`,d.style.top=`${i}px`}(e,n)})}),s.historyList.querySelectorAll(".delete-btn").forEach(t=>{t.addEventListener("click",async e=>{e.stopPropagation();const n=t.getAttribute("data-id");n&&confirm("Delete this transcription?")&&(await o(n),await h())})})}function v(t,e){let n;if(t)n=Math.round(t);else{const t=e/150;n=Math.round(60*t)}if(n<60)return`${n}s`;const i=Math.floor(n/60),o=n%60;return o>0?`${i}m ${o}s`:`${i}m`}function g(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}function p(t){document.querySelectorAll(".card-toast").forEach(t=>t.remove());const e=document.createElement("div");e.className="card-toast",e.textContent="Copied!",t.appendChild(e),setTimeout(()=>{e.classList.add("show")},10),setTimeout(()=>{e.classList.remove("show"),setTimeout(()=>e.remove(),300)},1500)}function w(){d&&(d.style.display="none"),l=null}function f(){u&&(u.style.display="none"),document.querySelector(".header")?.classList.remove("hidden"),document.querySelector(".search-section")?.classList.remove("hidden"),s.historyList.classList.remove("hidden")}!async function(){await h(),s.searchInput.addEventListener("input",t=>{r=t.target.value.toLowerCase(),c=50,y()}),s.historyList.addEventListener("scroll",()=>{const{scrollTop:t,scrollHeight:e,clientHeight:n}=s.historyList;t+n>=e-100&&function(){const t=r?a.filter(t=>t.text.toLowerCase().includes(r)):a;c<t.length&&(c=Math.min(c+50,t.length),y())}()}),chrome.storage.onChanged.addListener((t,e)=>{"local"===e&&t.settings?.newValue?.history&&(a=t.settings.newValue.history||[],c=50,m(),y())}),d=document.createElement("div"),d.className="context-menu",d.innerHTML='\n\t\t<button class="context-menu-item" data-action="view">View</button>\n\t\t<button class="context-menu-item" data-action="copy">Copy</button>\n\t\t<button class="context-menu-item" data-action="delete">Delete</button>\n\t',d.style.display="none",document.body.appendChild(d),d.addEventListener("click",async t=>{const e=t.target.closest(".context-menu-item");if(!e||!l)return;const n=e.getAttribute("data-action"),i=a.find(t=>t.id===l);if("view"===n&&i)!function(t){u||(u=document.createElement("div"),u.className="detail-view",s.container.appendChild(u));const e=new Date(t.timestamp),n=e.toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),i=e.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"});u.innerHTML=`\n\t\t<div class="detail-header">\n\t\t\t<button class="back-btn">\n\t\t\t\t<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n\t\t\t\t\t<path d="M19 12H5M12 19l-7-7 7-7"/>\n\t\t\t\t</svg>\n\t\t\t\tBack\n\t\t\t</button>\n\t\t\t<div class="detail-actions">\n\t\t\t\t<button class="detail-action-btn" data-action="copy">Copy</button>\n\t\t\t\t<button class="detail-action-btn detail-delete-btn" data-action="delete" data-id="${t.id}">Delete</button>\n\t\t\t</div>\n\t\t</div>\n\t\t<div class="detail-meta">\n\t\t\t<div class="detail-date">${n}</div>\n\t\t\t<div class="detail-time">${i} · ${v(t.duration,t.wordCount)} · ${t.wordCount} words</div>\n\t\t</div>\n\t\t<div class="detail-text">${g(t.text)}</div>\n\t`,u.querySelector(".back-btn")?.addEventListener("click",f),u.querySelector('[data-action="copy"]')?.addEventListener("click",async()=>{await navigator.clipboard.writeText(t.text);const e=u?.querySelector('[data-action="copy"]');e&&(e.textContent="Copied",setTimeout(()=>{e.textContent="Copy"},1500))}),u.querySelector('[data-action="delete"]')?.addEventListener("click",async()=>{confirm("Delete this transcription?")&&(await o(t.id),f(),await h())}),u.style.display="flex",document.querySelector(".header")?.classList.add("hidden"),document.querySelector(".search-section")?.classList.add("hidden"),s.historyList.classList.add("hidden")}(i);else if("copy"===n&&i){await navigator.clipboard.writeText(i.text);const t=document.querySelector(`.history-item[data-id="${l}"]`);t&&p(t)}else"delete"===n&&l&&(await o(l),await h());w()}),document.addEventListener("click",t=>{d&&!d.contains(t.target)&&w()}),s.historyList.addEventListener("scroll",w)}()})();