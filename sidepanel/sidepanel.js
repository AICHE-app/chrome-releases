(()=>{"use strict";const t={encryptedAccessToken:void 0,encryptedRefreshToken:void 0,tokenStorageVersion:void 0,machineId:void 0,deviceId:void 0,accessToken:void 0,refreshToken:void 0,tokenExpiresAt:0,userEmail:"",userId:null,isSubscribed:!1,subscriptionPlan:null,autoPaste:!0,showNotifications:!0,showFloatingWidget:!0,typingSpeed:"instant",historyRetentionDays:30,themePreference:"system",hasShownWelcome:!1,hasGivenPrivacyConsent:!1,pendingTranscriptions:[],history:[]};let e=null;async function n(){if(e)return{...e};const n=await chrome.storage.local.get("settings"),i={...t,...n.settings||{}};return e=i,i}async function i(){const e=await chrome.storage.local.get("settings");return{...t,...e.settings||{}}.history||[]}async function o(t){const o=(await i()).filter(e=>e.id!==t);await async function(t){const i=await n();e={...i,...t},await chrome.storage.local.set({settings:e}),e=null}({history:o})}let s="system",a=null,r=!1;function c(t){return"light"===t||"dark"===t||"system"===t?t:"system"}function d(t){!function(t){const e=document.documentElement;e.dataset.theme=t,e.style.colorScheme=t}(function(t){return"light"===t||"dark"===t?t:window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}(t))}const l={searchInput:document.getElementById("search-input"),historyList:document.getElementById("history-list"),container:document.querySelector(".sidepanel-container"),headerStats:document.getElementById("header-stats")};let u=[],h="",m=50;let y=null,g=null,w=null;async function f(){u=await i(),v(),p()}function v(){const t=u.length,e=u.reduce((t,e)=>t+(e.wordCount||0),0);l.headerStats.innerHTML=`\n\t\t<div><span class="stat-value">${t}</span> notes</div>\n\t\t<div><span class="stat-value">${e}</span> words</div>\n\t`}function p(){const t=h?u.filter(t=>t.text.toLowerCase().includes(h)):u;if(0===t.length)return void(l.historyList.innerHTML=h?'<p class="empty-state">No results found</p>':'<p class="empty-state">No transcriptions yet</p>');const e=t.slice(0,m),n=m<t.length;l.historyList.innerHTML=e.map(t=>`\n\t\t<div class="history-item" data-id="${t.id}">\n\t\t\t<div class="history-header">\n\t\t\t\t<span class="history-time">${function(t){const e=Date.now()-t,n=Math.floor(e/1e3),i=Math.floor(n/60),o=Math.floor(i/60),s=Math.floor(o/24);return n<60?"just now":i<60?1===i?"1m ago":`${i}m ago`:o<24?1===o?"1h ago":`${o}h ago`:s<7?1===s?"1d ago":`${s}d ago`:new Date(t).toLocaleDateString("en-US",{month:"short",day:"numeric"})}(t.timestamp)}</span>\n\t\t\t\t<div class="history-meta-right">\n\t\t\t\t\t<span class="history-meta">${L(t.duration,t.wordCount)} · ${t.wordCount} words</span>\n\t\t\t\t\t<button class="delete-btn" data-id="${t.id}" title="Delete">×</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="history-text">${function(t,e){const n=function(t,e){const n=120;if(!e)return t.length>n?t.slice(0,n)+"...":t;const i=e.toLowerCase(),o=t.toLowerCase().indexOf(i);if(-1===o)return t.length>n?t.slice(0,n)+"...":t;if(o<n)return t.length>n?t.slice(0,n)+"...":t;const s=Math.max(0,o-50),a=Math.min(t.length,o+e.length+50);let r="";return s>0&&(r+="..."),r+=t.slice(s,a),a<t.length&&(r+="..."),r}(t,e);if(!e)return b(n);const i=b(n),o=e.toLowerCase(),s=i.toLowerCase();let a="",r=0,c=s.indexOf(o);for(;-1!==c;)a+=i.slice(r,c),a+=`<mark class="search-highlight">${i.slice(c,c+e.length)}</mark>`,r=c+e.length,c=s.indexOf(o,r);return a+=i.slice(r),a}(t.text,h)}</div>\n\t\t</div>\n\t`).join("")+(n?'<div class="load-more-indicator">Scroll for more...</div>':""),l.historyList.querySelectorAll(".history-item").forEach(t=>{t.addEventListener("click",async e=>{if(e.target.classList.contains("delete-btn"))return;const n=t.getAttribute("data-id"),i=u.find(t=>t.id===n);i&&(await navigator.clipboard.writeText(i.text),x(t))}),t.addEventListener("contextmenu",e=>{const n=t.getAttribute("data-id");n&&function(t,e){if(t.preventDefault(),!y)return;g=e,y.style.display="block";let n=t.clientX,i=t.clientY;n+150>window.innerWidth&&(n=window.innerWidth-150-10),i+80>window.innerHeight&&(i=window.innerHeight-80-10),y.style.left=`${n}px`,y.style.top=`${i}px`}(e,n)})}),l.historyList.querySelectorAll(".delete-btn").forEach(t=>{t.addEventListener("click",async e=>{e.stopPropagation();const n=t.getAttribute("data-id");n&&confirm("Delete this transcription?")&&(await o(n),await f())})})}function L(t,e){let n;if(t)n=Math.round(t);else{const t=e/150;n=Math.round(60*t)}if(n<60)return`${n}s`;const i=Math.floor(n/60),o=n%60;return o>0?`${i}m ${o}s`:`${i}m`}function b(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}function x(t){document.querySelectorAll(".card-toast").forEach(t=>t.remove());const e=document.createElement("div");e.className="card-toast",e.textContent="Copied!",t.appendChild(e),setTimeout(()=>{e.classList.add("show")},10),setTimeout(()=>{e.classList.remove("show"),setTimeout(()=>e.remove(),300)},1500)}function k(){y&&(y.style.display="none"),g=null}function C(){w&&(w.style.display="none"),document.querySelector(".header")?.classList.remove("hidden"),document.querySelector(".search-section")?.classList.remove("hidden"),l.historyList.classList.remove("hidden")}!async function(){await async function(){const t=await n();if(s=c(t.themePreference),d(s),!a&&window.matchMedia){a=window.matchMedia("(prefers-color-scheme: dark)");const t=()=>{"system"===s&&d("system")};a.addEventListener?a.addEventListener("change",t):a.addListener(t)}r||(chrome.storage.onChanged.addListener((t,e)=>{if("local"!==e||!t.settings?.newValue)return;if(!("themePreference"in t.settings.newValue))return;const n=c(t.settings.newValue.themePreference);n!==s&&(s=n,d(s))}),r=!0)}(),await f(),l.searchInput.addEventListener("input",t=>{h=t.target.value.toLowerCase(),m=50,p()}),l.historyList.addEventListener("scroll",()=>{const{scrollTop:t,scrollHeight:e,clientHeight:n}=l.historyList;t+n>=e-100&&function(){const t=h?u.filter(t=>t.text.toLowerCase().includes(h)):u;m<t.length&&(m=Math.min(m+50,t.length),p())}()}),chrome.storage.onChanged.addListener((t,e)=>{"local"===e&&t.settings?.newValue?.history&&(u=t.settings.newValue.history||[],m=50,v(),p())}),y=document.createElement("div"),y.className="context-menu",y.innerHTML='\n\t\t<button class="context-menu-item" data-action="view">View</button>\n\t\t<button class="context-menu-item" data-action="copy">Copy</button>\n\t\t<button class="context-menu-item" data-action="delete">Delete</button>\n\t',y.style.display="none",document.body.appendChild(y),y.addEventListener("click",async t=>{const e=t.target.closest(".context-menu-item");if(!e||!g)return;const n=e.getAttribute("data-action"),i=u.find(t=>t.id===g);if("view"===n&&i)!function(t){w||(w=document.createElement("div"),w.className="detail-view",l.container.appendChild(w));const e=new Date(t.timestamp),n=e.toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),i=e.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"});w.innerHTML=`\n\t\t<div class="detail-header">\n\t\t\t<button class="back-btn">\n\t\t\t\t<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n\t\t\t\t\t<path d="M19 12H5M12 19l-7-7 7-7"/>\n\t\t\t\t</svg>\n\t\t\t\tBack\n\t\t\t</button>\n\t\t\t<div class="detail-actions">\n\t\t\t\t<button class="detail-action-btn" data-action="copy">Copy</button>\n\t\t\t\t<button class="detail-action-btn detail-delete-btn" data-action="delete" data-id="${t.id}">Delete</button>\n\t\t\t</div>\n\t\t</div>\n\t\t<div class="detail-meta">\n\t\t\t<div class="detail-date">${n}</div>\n\t\t\t<div class="detail-time">${i} · ${L(t.duration,t.wordCount)} · ${t.wordCount} words</div>\n\t\t</div>\n\t\t<div class="detail-text">${b(t.text)}</div>\n\t`,w.querySelector(".back-btn")?.addEventListener("click",C),w.querySelector('[data-action="copy"]')?.addEventListener("click",async()=>{await navigator.clipboard.writeText(t.text);const e=w?.querySelector('[data-action="copy"]');e&&(e.textContent="Copied",setTimeout(()=>{e.textContent="Copy"},1500))}),w.querySelector('[data-action="delete"]')?.addEventListener("click",async()=>{confirm("Delete this transcription?")&&(await o(t.id),C(),await f())}),w.style.display="flex",document.querySelector(".header")?.classList.add("hidden"),document.querySelector(".search-section")?.classList.add("hidden"),l.historyList.classList.add("hidden")}(i);else if("copy"===n&&i){await navigator.clipboard.writeText(i.text);const t=document.querySelector(`.history-item[data-id="${g}"]`);t&&x(t)}else"delete"===n&&g&&(await o(g),await f());k()}),document.addEventListener("click",t=>{y&&!y.contains(t.target)&&k()}),l.historyList.addEventListener("scroll",k)}()})();