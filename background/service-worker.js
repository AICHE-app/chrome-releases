(()=>{"use strict";const e={encryptedAccessToken:void 0,encryptedRefreshToken:void 0,tokenStorageVersion:void 0,machineId:void 0,deviceId:void 0,accessToken:void 0,refreshToken:void 0,tokenExpiresAt:0,userEmail:"",userId:null,isSubscribed:!1,subscriptionPlan:null,autoPaste:!0,showNotifications:!0,showFloatingWidget:!0,typingSpeed:"instant",historyRetentionDays:30,themePreference:"system",hasShownWelcome:!1,hasGivenPrivacyConsent:!1,pendingTranscriptions:[],history:[]};const t="https://api.aiche.app";class n{constructor(){this.onTokenRefresh=null,this.refreshPromise=null,this.accessToken="",this.refreshToken=""}setTokens(e,t){this.accessToken=e,this.refreshToken=t}setTokenRefreshCallback(e){this.onTokenRefresh=e}async activateDeviceCode(e,n){const o=await fetch(`${t}/api/v1/auth/device/activate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:e.trim(),device_info:n})});if(!o.ok){const e=await o.json().catch(()=>({detail:"Activation failed"}));throw new Error(e.detail||"Activation failed")}const r=await o.json();return this.setTokens(r.access_token,r.refresh_token),r}async refreshAccessToken(){if(this.refreshPromise)return this.refreshPromise;this.refreshPromise=this.performTokenRefresh();try{return await this.refreshPromise}finally{this.refreshPromise=null}}async performTokenRefresh(){if(!this.refreshToken)throw new Error("No refresh token available");const e=await fetch(`${t}/api/v1/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`refresh_token=${encodeURIComponent(this.refreshToken)}`});if(!e.ok)throw new Error("Token refresh failed");const n=await e.json(),o={access_token:n.access_token,refresh_token:n.refresh_token||this.refreshToken,token_type:n.token_type||"bearer",expires_in:n.expires_in||691200};return this.setTokens(o.access_token,o.refresh_token),this.onTokenRefresh&&this.onTokenRefresh(o),o}async request(e){const t=e.headers||{};this.accessToken&&(t.Authorization=`Bearer ${this.accessToken}`);try{const n=await fetch(e.url,{method:e.method,headers:t,body:e.body});if(!n.ok){if(401===n.status&&!e.retried&&this.refreshToken)try{await this.refreshAccessToken(),t.Authorization=`Bearer ${this.accessToken}`;const n=await fetch(e.url,{method:e.method,headers:t,body:e.body});if(!n.ok)throw new Error("Session expired. Please reconnect your account.");return n.json()}catch{throw new Error("Session expired. Please reconnect your account.")}const o=await n.json().catch(()=>({detail:"Request failed"}));throw new Error(o.detail||"Request failed")}return n.json()}catch(e){throw new Error(function(e){return e instanceof Error||"object"==typeof(t=e)&&null!==t&&"message"in t&&"string"==typeof t.message?e.message:"string"==typeof e?e:"Unknown error";var t}(e))}}async getUserProfile(){return this.request({url:`${t}/api/v1/auth/me`,method:"GET"})}async transcribeAudio(e,n){const o="----AicheFormBoundary"+Math.random().toString(36).substring(2),r=`--${o}\r\nContent-Disposition: form-data; name="request"\r\nContent-Type: application/json\r\n\r\n${JSON.stringify({include_category:!1})}\r\n`,a=`--${o}\r\nContent-Disposition: form-data; name="file"; filename="${n}"\r\nContent-Type: audio/webm\r\n\r\n`,i=`\r\n--${o}--\r\n`,s=(new TextEncoder).encode(r),c=(new TextEncoder).encode(a),d=(new TextEncoder).encode(i),u=new Uint8Array(e),h=s.length+c.length+u.length+d.length,l=new Uint8Array(h);l.set(s,0),l.set(c,s.length),l.set(u,s.length+c.length),l.set(d,s.length+c.length+u.length);const f=l.buffer.slice(l.byteOffset,l.byteOffset+l.byteLength);return this.request({url:`${t}/api/v1/transcription/audio/direct`,method:"POST",headers:{"Content-Type":`multipart/form-data; boundary=${o}`},body:f})}async pollTranscriptionStatus(e,n=30){for(let o=0;o<n;o++){const n=await this.request({url:`${t}/api/v1/transcription/${e}`,method:"GET"});if("completed"===n.status||"failed"===n.status)return n;await new Promise(e=>setTimeout(e,Math.min(1e3+200*o,3e3)))}throw new Error("Transcription timed out")}async logout(){if(this.accessToken)try{await this.request({url:`${t}/api/v1/auth/logout`,method:"POST"})}catch{}this.accessToken="",this.refreshToken=""}}async function o(e,t){const n=new TextEncoder,o=await crypto.subtle.importKey("raw",n.encode(e),"PBKDF2",!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:t.buffer,iterations:1e5,hash:"SHA-256"},o,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}function r(e){const t=new Uint8Array(e);let n="";for(let e=0;e<t.byteLength;e++)n+=String.fromCharCode(t[e]);return btoa(n)}function a(e){const t=atob(e),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n}async function i(e,t,n){if(!e)throw new Error("Cannot encrypt empty token");const a=crypto.getRandomValues(new Uint8Array(16)),i=crypto.getRandomValues(new Uint8Array(12)),s=`${t}:${n}:aiche-voice`,c=await o(s,a),d=new TextEncoder;return{ciphertext:r(await crypto.subtle.encrypt({name:"AES-GCM",iv:i},c,d.encode(e))),iv:r(i.buffer),salt:r(a.buffer)}}async function s(e,t,n){if(!(e&&e.ciphertext&&e.iv&&e.salt))throw new Error("Invalid encrypted data");const r=a(e.ciphertext),i=a(e.iv),s=a(e.salt),c=`${t}:${n}:aiche-voice`,d=await o(c,s),u=await crypto.subtle.decrypt({name:"AES-GCM",iv:i.buffer},d,r.buffer);return(new TextDecoder).decode(u)}function c(){return!("undefined"==typeof crypto||!crypto.subtle||"function"!=typeof crypto.subtle.encrypt||"function"!=typeof crypto.subtle.decrypt||"function"!=typeof crypto.getRandomValues)}let d=null;async function u(){if(d)return{...d};const t=await chrome.storage.local.get("settings"),n={...e,...t.settings||{}};return d=n,n}async function h(e){const t=await u();d={...t,...e},await chrome.storage.local.set({settings:d}),d=null}function l(){return chrome.runtime.id}async function f(){const e=await u();if(e.machineId)return e.machineId;const t=crypto.randomUUID();return await h({machineId:t}),t}async function w(e){if(!c())throw new Error("Cannot save tokens - Web Crypto API unavailable");const t=l(),n=await f(),o=await i(e,t,n);await h({encryptedAccessToken:o,tokenStorageVersion:2,accessToken:void 0})}async function y(e){if(!c())throw new Error("Cannot save tokens - Web Crypto API unavailable");const t=l(),n=await f(),o=await i(e,t,n);await h({encryptedRefreshToken:o,tokenStorageVersion:2,refreshToken:void 0})}async function m(){const e=await u();if(e.encryptedAccessToken){const t=l(),n=await f();try{return await s(e.encryptedAccessToken,t,n)}catch(e){return console.error("[AICHE] Failed to decrypt access token:",e),null}}return e.accessToken?(await w(e.accessToken),e.accessToken):null}async function p(){const e=await u();if(e.encryptedRefreshToken){const t=l(),n=await f();try{return await s(e.encryptedRefreshToken,t,n)}catch(e){return console.error("[AICHE] Failed to decrypt refresh token:",e),null}}return e.refreshToken?(await y(e.refreshToken),e.refreshToken):null}async function g(){const t=await chrome.storage.local.get("settings");return{...e,...t.settings||{}}.history||[]}async function T(e){const t=[e,...await g()].slice(0,500);await h({history:t})}async function b(){return(await u()).pendingTranscriptions||[]}async function E(e){await h({pendingTranscriptions:e})}async function I(){const e=function(e){let t=0,n=0,o=0;for(const r of e)Date.now()-r.timestamp>864e5?n++:r.retryCount>=3?o++:t++;return{total:e.length,pending:t,expired:n,maxRetries:o}}(await b());e.pending>0?(await chrome.action.setBadgeText({text:e.pending.toString()}),await chrome.action.setBadgeBackgroundColor({color:"#FF6B35"})):await chrome.action.setBadgeText({text:""})}let k=null;async function C(){if(k)return k;k=new n;const e=await m(),t=await p();return e&&t&&k.setTokens(e,t),k.setTokenRefreshCallback(async e=>{await w(e.access_token),await y(e.refresh_token),await h({tokenExpiresAt:Date.now()+1e3*e.expires_in})}),k}function v(e){const t=atob(e),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n.buffer}function A(e){return e.retryCount<3&&!function(e){return Date.now()-e.timestamp>864e5}(e)}function R(e){return{...e,retryCount:e.retryCount+1}}function x(e,t){return e.filter(e=>e.id!==t)}function _(e){for(const t of e)if(A(t))return t;return null}function D(e){return e.filter(e=>A(e))}function S(e={}){if(!chrome.sidePanel||!chrome.sidePanel.open)return void chrome.tabs.create({url:chrome.runtime.getURL("sidepanel/sidepanel.html")});const t="number"==typeof e.tabId?{tabId:e.tabId}:{windowId:"number"==typeof e.windowId?e.windowId:chrome.windows.WINDOW_ID_CURRENT};chrome.sidePanel.open(t).catch(e=>{console.error("[AICHE] Failed to open history side panel:",e)})}let U=!1,P=[],O=null,N=null,H=!1,F=!1,$=null,L=null;function M(e,t){"number"==typeof e&&($=e),"number"==typeof t&&t!==chrome.windows.WINDOW_ID_NONE&&(L=t)}async function W(){try{await chrome.action.setIcon({path:{16:"/assets/icons/icon-16.png",32:"/assets/icons/icon-32.png"}})}catch(e){console.error("[SERVICE WORKER] Failed to set default icon:",e)}}async function G(e,t=!1){if(!U){H=t;try{if(!await async function(){const e=await m(),t=await p(),n=await u();if(!e||!t)return!1;if(n.tokenExpiresAt>Date.now())return!0;try{const e=await C();return await e.refreshAccessToken(),!0}catch{return!1}}())throw new Error("Not authenticated");U=!0,P=[],O=e,N=Date.now(),await async function(){try{await chrome.action.setIcon({path:{16:"/assets/icons/icon-recording-16.png",32:"/assets/icons/icon-recording-32.png"}})}catch(e){console.error("[SERVICE WORKER] Failed to set recording icon:",e)}}();try{await chrome.scripting.executeScript({target:{tabId:e},files:["content/recording-widget.js"]}),await chrome.tabs.sendMessage(e,{type:"SHOW_RECORDING_WIDGET"})}catch{}await async function(){await async function(){try{const e=await chrome.runtime.getContexts({contextTypes:["OFFSCREEN_DOCUMENT"]});if(e&&e.length>0)return void(F=!0);F=!1,await chrome.offscreen.createDocument({url:chrome.runtime.getURL("offscreen/offscreen.html"),reasons:["USER_MEDIA"],justification:"Recording voice for transcription"})}catch(e){throw console.error("[AICHE] Failed to create offscreen document:",e),e}}();const e=Date.now();for(;!F&&Date.now()-e<3e3;)await new Promise(e=>setTimeout(e,50))}(),await chrome.runtime.sendMessage({type:"START_RECORDING"}),await B()}catch(e){throw console.error("[AICHE] Failed to start recording:",e),U=!1,P=[],O=null,H=!1,await B(),e}}}async function V(){if(U)try{if(U=!1,O)try{await chrome.tabs.sendMessage(O,{type:"HIDE_RECORDING_WIDGET"})}catch{}if(await chrome.runtime.sendMessage({type:"STOP_RECORDING"}),0===P.length)return;const e=P.reduce((e,t)=>e+t.byteLength,0),t=new Uint8Array(e);let n=0;for(const e of P)t.set(new Uint8Array(e),n),n+=e.byteLength;P=[],await async function(e){await async function(){try{await chrome.action.setIcon({path:{16:"/assets/icons/icon-ready-16.png",32:"/assets/icons/icon-ready-32.png"}})}catch(e){console.error("[SERVICE WORKER] Failed to set ready icon:",e)}}();try{const t=await C(),n=`recording-${Date.now()}.webm`,o=await t.transcribeAudio(e,n);if("failed"===o.status)throw new Error(o.error||"Transcription failed");const r=o.enhanced_text||o.text;if(r){const e={id:crypto.randomUUID(),text:r,timestamp:Date.now(),wordCount:o.word_count||0,language:o.language||void 0,duration:o.duration||void 0};await T(e);const t=O;if(t)try{await chrome.scripting.executeScript({target:{tabId:t},func:e=>{navigator.clipboard.writeText(e).catch(()=>{const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t)})},args:[r]})}catch{}chrome.runtime.sendMessage({type:"TRANSCRIPTION_COMPLETE",wordCount:o.word_count||0,text:r}).catch(()=>{});const n=await u();if((n.autoPaste||H)&&O&&await async function(e,t){try{await chrome.scripting.executeScript({target:{tabId:e},files:["content/content.js"]}),await chrome.tabs.sendMessage(e,{type:"PASTE_TEXT",text:t})}catch{}}(O,r),H=!1,n.showNotifications)try{await chrome.notifications.create({type:"basic",iconUrl:"assets/icons/icon-128.png",title:"AICHE Voice-to-Text",message:"Transcription complete"})}catch{}}else await chrome.notifications.create({type:"basic",iconUrl:"assets/icons/icon-128.png",title:"AICHE Voice-to-Text",message:"No speech detected"});O=null,N=null,await W(),await B()}catch(t){if(console.error("[AICHE] Transcription failed:",t),q(t)){const t=l(),n=await f(),o=`recording-${Date.now()}.webm`,a=await async function(e,t,n,o){if(!c())throw new Error("Web Crypto API unavailable - cannot securely save offline recordings");const a=r(e),s=await i(a,n,o);return{id:`${Date.now()}-${Math.random().toString(36).substring(2,9)}`,audioData:s,filename:t,timestamp:Date.now(),retryCount:0}}(e,o,t,n),s=[...await b(),a];await E(s),await I(),(await u()).showNotifications&&await chrome.notifications.create({type:"basic",iconUrl:"assets/icons/icon-128.png",title:"AICHE Voice-to-Text",message:"Offline - recording saved for retry"})}else await chrome.notifications.create({type:"basic",iconUrl:"assets/icons/icon-128.png",title:"AICHE Voice-to-Text",message:"Transcription failed"});O=null,N=null,H=!1,await W(),await B()}}(t.buffer)}catch(e){throw console.error("[AICHE] Failed to stop recording:",e),e}}function q(e){const t=String(e).toLowerCase();return!navigator.onLine||t.includes("network")||t.includes("fetch")||t.includes("connection")||t.includes("timeout")||t.includes("econnrefused")||t.includes("enotfound")||t.includes("net::err")}async function j(){let e=await b();for(;;){const t=_(e);if(!t)return await E(D(e)),void await I();try{const n=l(),o=await f();let r;try{r=v(await s(t.audioData,n,o))}catch(n){console.error("[AICHE] Failed to decrypt queued audio:",n),e=x(e,t.id),await E(e),await I();continue}const a=await C(),i=await a.transcribeAudio(r,t.filename);if("failed"===i.status)throw new Error(i.error||"Transcription failed");const c=i.enhanced_text||i.text;if(c){const e={id:crypto.randomUUID(),text:c,timestamp:Date.now(),wordCount:i.word_count||0,language:i.language||void 0,duration:i.duration||void 0};await T(e),(await u()).showNotifications&&await chrome.notifications.create({type:"basic",iconUrl:"assets/icons/icon-128.png",title:"AICHE Voice-to-Text",message:`Saved recording processed: ${i.word_count||0} words`})}e=x(e,t.id),await E(e),await I()}catch(n){if(console.error("[AICHE] Retry failed:",n),q(n))return;const o=R(t);o.retryCount>=3?(e=x(e,t.id),await E(e),(await u()).showNotifications&&await chrome.notifications.create({type:"basic",iconUrl:"assets/icons/icon-128.png",title:"AICHE Voice-to-Text",message:"Recording failed after 3 attempts"})):(e=e.map(e=>e.id===t.id?o:e),await E(e)),await I()}}}async function B(){try{await chrome.contextMenus.removeAll(),U?chrome.contextMenus.create({id:"stop-recording",title:"Stop Recording",contexts:["editable","action"]}):chrome.contextMenus.create({id:"start-recording",title:"Record and Insert Here",contexts:["editable","action"]}),chrome.contextMenus.create({id:"separator-1",type:"separator",contexts:["editable","action"]}),chrome.contextMenus.create({id:"view-history",title:"View History",contexts:["editable","action"]})}catch(e){console.error("[AICHE] Failed to update context menu:",e)}}chrome.commands.onCommand.addListener(async e=>{if("toggle-recording"===e){const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e.id)return;U?await V():await G(e.id)}else"open-history"===e&&S({tabId:$??void 0,windowId:L??void 0})}),chrome.runtime.onMessage.addListener((e,t,n)=>{if("OFFSCREEN_READY"!==e.type){if("AUDIO_CHUNK"===e.type){const t=new Uint8Array(e.chunk),n=t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength);return void P.push(n)}if("RECORDING_ERROR"===e.type)return console.error("[AICHE] Recording error:",e.error),U=!1,P=[],O=null,H=!1,void((e.error.includes("dismissed")||e.error.includes("denied"))&&chrome.tabs.create({url:chrome.runtime.getURL("request-permission.html")}));if("GET_RECORDING_STATE"===e.type)return n({isRecording:U,recordingStartTime:N}),!0;if("START_RECORDING"===e.type)return e.tabId?(G(e.tabId).then(()=>n({success:!0})).catch(e=>n({success:!1,error:e.message})),!0):void 0;if("STOP_RECORDING"===e.type)return V().then(()=>n({success:!0})).catch(e=>n({success:!1,error:e.message})),!0;if("RETRY_PENDING"===e.type)return j().then(()=>n({success:!0})),!0;if("CLEAR_QUEUE"===e.type)return E([]).then(async()=>{await I(),n({success:!0})}),!0;if("AUTH_CALLBACK"===e.type){const t=new URLSearchParams(e.params),o=t.get("code")||t.get("token");if(o)return async function(e){const t=await C(),n=await async function(){const e=await u();if(e.deviceId)return e.deviceId;const t=crypto.randomUUID();return await h({deviceId:t}),t}(),o=chrome.runtime.getManifest().version,r=(await chrome.runtime.getPlatformInfo()).os,a={name:"Chrome Extension",device_fingerprint:chrome.runtime.id,device_id:n,os:r,app_version:o},i=await t.activateDeviceCode(e,a);await w(i.access_token),await y(i.refresh_token),await h({tokenExpiresAt:Date.now()+1e3*i.expires_in,userEmail:i.user.email,userId:i.user.id});const s=await t.getUserProfile();await h({isSubscribed:s.is_premium,subscriptionPlan:s.plan_name||null})}(o).then(()=>n({success:!0})).catch(e=>{console.error("[AICHE] Auth callback failed:",e),n({success:!1,error:e.message})}),!0;n({success:!1,error:"No code found"})}}else F=!0}),chrome.contextMenus.onClicked.addListener((e,t)=>{"start-recording"===e.menuItemId?chrome.tabs.query({active:!0,currentWindow:!0}).then(([e])=>{if(e?.id)return G(e.id,!0)}).then(()=>B()).catch(e=>{console.error("[AICHE] Failed to start recording from context menu:",e)}):"stop-recording"===e.menuItemId?V().then(()=>B()).catch(e=>{console.error("[AICHE] Failed to stop recording from context menu:",e)}):"view-history"===e.menuItemId&&S({tabId:t?.id??$??void 0,windowId:t?.windowId??L??void 0})}),chrome.runtime.onInstalled.addListener(async e=>{"install"===e.reason&&await chrome.tabs.create({url:"https://aiche.app/connect-chrome"}),await I(),await B()}),chrome.runtime.onStartup.addListener(async()=>{await B()}),chrome.tabs.onActivated.addListener(e=>{M(e.tabId,e.windowId)}),chrome.windows.onFocusChanged.addListener(e=>{e!==chrome.windows.WINDOW_ID_NONE&&M($,e)}),chrome.tabs.onRemoved.addListener(e=>{$===e&&($=null)}),setInterval(async()=>{(await b()).length>0&&await j()},6e4),B().catch(e=>{console.error("[AICHE] Failed to initialize context menu:",e)}),chrome.tabs.query({active:!0,lastFocusedWindow:!0}).then(([e])=>{e?.id&&M(e.id,e.windowId)}).catch(()=>{}),chrome.windows.getLastFocused().then(e=>{e?.id&&M($,e.id)}).catch(()=>{})})();