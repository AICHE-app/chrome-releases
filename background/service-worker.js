(()=>{"use strict";const e={encryptedAccessToken:void 0,encryptedRefreshToken:void 0,tokenStorageVersion:void 0,machineId:void 0,deviceId:void 0,accessToken:void 0,refreshToken:void 0,tokenExpiresAt:0,userEmail:"",userId:null,isSubscribed:!1,subscriptionPlan:null,autoPaste:!0,showNotifications:!0,showFloatingWidget:!0,typingSpeed:"instant",historyRetentionDays:30,hasShownWelcome:!1,hasGivenPrivacyConsent:!1,pendingTranscriptions:[],history:[]};const t="https://api.aiche.app";class n{constructor(){this.onTokenRefresh=null,this.refreshPromise=null,this.accessToken="",this.refreshToken=""}setTokens(e,t){this.accessToken=e,this.refreshToken=t}setTokenRefreshCallback(e){this.onTokenRefresh=e}async activateDeviceCode(e,n){const r=await fetch(`${t}/api/v1/auth/device/activate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:e.trim(),device_info:n})});if(!r.ok){const e=await r.json().catch(()=>({detail:"Activation failed"}));throw new Error(e.detail||"Activation failed")}const o=await r.json();return this.setTokens(o.access_token,o.refresh_token),o}async refreshAccessToken(){if(this.refreshPromise)return this.refreshPromise;this.refreshPromise=this.performTokenRefresh();try{return await this.refreshPromise}finally{this.refreshPromise=null}}async performTokenRefresh(){if(!this.refreshToken)throw new Error("No refresh token available");const e=await fetch(`${t}/api/v1/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`refresh_token=${encodeURIComponent(this.refreshToken)}`});if(!e.ok)throw new Error("Token refresh failed");const n=await e.json(),r={access_token:n.access_token,refresh_token:n.refresh_token||this.refreshToken,token_type:n.token_type||"bearer",expires_in:n.expires_in||691200};return this.setTokens(r.access_token,r.refresh_token),this.onTokenRefresh&&this.onTokenRefresh(r),r}async request(e){const t=e.headers||{};this.accessToken&&(t.Authorization=`Bearer ${this.accessToken}`);try{const n=await fetch(e.url,{method:e.method,headers:t,body:e.body});if(!n.ok){if(401===n.status&&!e.retried&&this.refreshToken)try{await this.refreshAccessToken(),t.Authorization=`Bearer ${this.accessToken}`;const n=await fetch(e.url,{method:e.method,headers:t,body:e.body});if(!n.ok)throw new Error("Session expired. Please reconnect your account.");return n.json()}catch{throw new Error("Session expired. Please reconnect your account.")}const r=await n.json().catch(()=>({detail:"Request failed"}));throw new Error(r.detail||"Request failed")}return n.json()}catch(e){throw new Error(function(e){return e instanceof Error||"object"==typeof(t=e)&&null!==t&&"message"in t&&"string"==typeof t.message?e.message:"string"==typeof e?e:"Unknown error";var t}(e))}}async getUserProfile(){return this.request({url:`${t}/api/v1/auth/me`,method:"GET"})}async transcribeAudio(e,n){const r="----AicheFormBoundary"+Math.random().toString(36).substring(2),o=`--${r}\r\nContent-Disposition: form-data; name="request"\r\nContent-Type: application/json\r\n\r\n${JSON.stringify({include_category:!1})}\r\n`,a=`--${r}\r\nContent-Disposition: form-data; name="file"; filename="${n}"\r\nContent-Type: audio/webm\r\n\r\n`,i=`\r\n--${r}--\r\n`,s=(new TextEncoder).encode(o),c=(new TextEncoder).encode(a),d=(new TextEncoder).encode(i),u=new Uint8Array(e),h=s.length+c.length+u.length+d.length,l=new Uint8Array(h);l.set(s,0),l.set(c,s.length),l.set(u,s.length+c.length),l.set(d,s.length+c.length+u.length);const f=l.buffer.slice(l.byteOffset,l.byteOffset+l.byteLength);return this.request({url:`${t}/api/v1/transcription/audio/direct`,method:"POST",headers:{"Content-Type":`multipart/form-data; boundary=${r}`},body:f})}async pollTranscriptionStatus(e,n=30){for(let r=0;r<n;r++){const n=await this.request({url:`${t}/api/v1/transcription/${e}`,method:"GET"});if("completed"===n.status||"failed"===n.status)return n;await new Promise(e=>setTimeout(e,Math.min(1e3+200*r,3e3)))}throw new Error("Transcription timed out")}async logout(){if(this.accessToken)try{await this.request({url:`${t}/api/v1/auth/logout`,method:"POST"})}catch{}this.accessToken="",this.refreshToken=""}}async function r(e,t){const n=new TextEncoder,r=await crypto.subtle.importKey("raw",n.encode(e),"PBKDF2",!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:t.buffer,iterations:1e5,hash:"SHA-256"},r,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}function o(e){const t=new Uint8Array(e);let n="";for(let e=0;e<t.byteLength;e++)n+=String.fromCharCode(t[e]);return btoa(n)}function a(e){const t=atob(e),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n}async function i(e,t,n){if(!e)throw new Error("Cannot encrypt empty token");const a=crypto.getRandomValues(new Uint8Array(16)),i=crypto.getRandomValues(new Uint8Array(12)),s=`${t}:${n}:aiche-voice`,c=await r(s,a),d=new TextEncoder;return{ciphertext:o(await crypto.subtle.encrypt({name:"AES-GCM",iv:i},c,d.encode(e))),iv:o(i.buffer),salt:o(a.buffer)}}async function s(e,t,n){if(!(e&&e.ciphertext&&e.iv&&e.salt))throw new Error("Invalid encrypted data");const o=a(e.ciphertext),i=a(e.iv),s=a(e.salt),c=`${t}:${n}:aiche-voice`,d=await r(c,s),u=await crypto.subtle.decrypt({name:"AES-GCM",iv:i.buffer},d,o.buffer);return(new TextDecoder).decode(u)}function c(){return!("undefined"==typeof crypto||!crypto.subtle||"function"!=typeof crypto.subtle.encrypt||"function"!=typeof crypto.subtle.decrypt||"function"!=typeof crypto.getRandomValues)}let d=null;async function u(){if(d)return{...d};const t=await chrome.storage.local.get("settings"),n={...e,...t.settings||{}};return d=n,n}async function h(e){const t=await u();d={...t,...e},await chrome.storage.local.set({settings:d}),d=null}function l(){return chrome.runtime.id}async function f(){const e=await u();if(e.machineId)return e.machineId;const t=crypto.randomUUID();return await h({machineId:t}),t}async function w(e){if(!c())throw new Error("Cannot save tokens - Web Crypto API unavailable");const t=l(),n=await f(),r=await i(e,t,n);await h({encryptedAccessToken:r,tokenStorageVersion:2,accessToken:void 0})}async function y(e){if(!c())throw new Error("Cannot save tokens - Web Crypto API unavailable");const t=l(),n=await f(),r=await i(e,t,n);await h({encryptedRefreshToken:r,tokenStorageVersion:2,refreshToken:void 0})}async function p(){const e=await u();if(e.encryptedAccessToken){const t=l(),n=await f();try{return await s(e.encryptedAccessToken,t,n)}catch(e){return console.error("[AICHE] Failed to decrypt access token:",e),null}}return e.accessToken?(await w(e.accessToken),e.accessToken):null}async function m(){const e=await u();if(e.encryptedRefreshToken){const t=l(),n=await f();try{return await s(e.encryptedRefreshToken,t,n)}catch(e){return console.error("[AICHE] Failed to decrypt refresh token:",e),null}}return e.refreshToken?(await y(e.refreshToken),e.refreshToken):null}async function g(){const t=await chrome.storage.local.get("settings");return{...e,...t.settings||{}}.history||[]}async function T(e){const t=[e,...await g()].slice(0,500);await h({history:t})}async function E(){return(await u()).pendingTranscriptions||[]}async function k(e){await h({pendingTranscriptions:e})}async function b(){const e=function(e){let t=0,n=0,r=0;for(const o of e)Date.now()-o.timestamp>864e5?n++:o.retryCount>=3?r++:t++;return{total:e.length,pending:t,expired:n,maxRetries:r}}(await E());e.pending>0?(await chrome.action.setBadgeText({text:e.pending.toString()}),await chrome.action.setBadgeBackgroundColor({color:"#FF6B35"})):await chrome.action.setBadgeText({text:""})}let C=null;async function I(){if(C)return C;C=new n;const e=await p(),t=await m();return e&&t&&C.setTokens(e,t),C.setTokenRefreshCallback(async e=>{await w(e.access_token),await y(e.refresh_token),await h({tokenExpiresAt:Date.now()+1e3*e.expires_in})}),C}function v(e){const t=atob(e),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n.buffer}function A(e){return e.retryCount<3&&!function(e){return Date.now()-e.timestamp>864e5}(e)}function R(e){return{...e,retryCount:e.retryCount+1}}function x(e,t){return e.filter(e=>e.id!==t)}function _(e){for(const t of e)if(A(t))return t;return null}function S(e){return e.filter(e=>A(e))}let D=!1,U=[],P=null,O=null,N=!1,H=!1;async function $(){try{await chrome.action.setIcon({path:{16:"/assets/icons/icon-16.png",32:"/assets/icons/icon-32.png"}})}catch(e){console.error("[SERVICE WORKER] Failed to set default icon:",e)}}async function M(e,t=!1){if(!D){N=t;try{if(!await async function(){const e=await p(),t=await m(),n=await u();if(!e||!t)return!1;if(n.tokenExpiresAt>Date.now())return!0;try{const e=await I();return await e.refreshAccessToken(),!0}catch{return!1}}())throw new Error("Not authenticated");D=!0,U=[],P=e,O=Date.now(),await async function(){try{await chrome.action.setIcon({path:{16:"/assets/icons/icon-recording-16.png",32:"/assets/icons/icon-recording-32.png"}})}catch(e){console.error("[SERVICE WORKER] Failed to set recording icon:",e)}}();try{await chrome.scripting.executeScript({target:{tabId:e},files:["content/recording-widget.js"]}),await chrome.tabs.sendMessage(e,{type:"SHOW_RECORDING_WIDGET"})}catch{}await async function(){await async function(){try{const e=await chrome.runtime.getContexts({contextTypes:["OFFSCREEN_DOCUMENT"]});if(e&&e.length>0)return void(H=!0);H=!1,await chrome.offscreen.createDocument({url:chrome.runtime.getURL("offscreen/offscreen.html"),reasons:["USER_MEDIA"],justification:"Recording voice for transcription"})}catch(e){throw console.error("[AICHE] Failed to create offscreen document:",e),e}}();const e=Date.now();for(;!H&&Date.now()-e<3e3;)await new Promise(e=>setTimeout(e,50))}(),await chrome.runtime.sendMessage({type:"START_RECORDING"}),await V()}catch(e){throw console.error("[AICHE] Failed to start recording:",e),D=!1,U=[],P=null,N=!1,await V(),e}}}async function F(){if(D)try{if(D=!1,P)try{await chrome.tabs.sendMessage(P,{type:"HIDE_RECORDING_WIDGET"})}catch{}if(await chrome.runtime.sendMessage({type:"STOP_RECORDING"}),0===U.length)return;const e=U.reduce((e,t)=>e+t.byteLength,0),t=new Uint8Array(e);let n=0;for(const e of U)t.set(new Uint8Array(e),n),n+=e.byteLength;U=[],await async function(e){await async function(){try{await chrome.action.setIcon({path:{16:"/assets/icons/icon-ready-16.png",32:"/assets/icons/icon-ready-32.png"}})}catch(e){console.error("[SERVICE WORKER] Failed to set ready icon:",e)}}();try{const t=await I(),n=`recording-${Date.now()}.webm`,r=await t.transcribeAudio(e,n);if("failed"===r.status)throw new Error(r.error||"Transcription failed");const o=r.enhanced_text||r.text;if(o){const e={id:crypto.randomUUID(),text:o,timestamp:Date.now(),wordCount:r.word_count||0,language:r.language||void 0,duration:r.duration||void 0};await T(e);const t=P;if(t)try{await chrome.scripting.executeScript({target:{tabId:t},func:e=>{navigator.clipboard.writeText(e).catch(()=>{const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t)})},args:[o]})}catch{}chrome.runtime.sendMessage({type:"TRANSCRIPTION_COMPLETE",wordCount:r.word_count||0,text:o}).catch(()=>{});const n=await u();if((n.autoPaste||N)&&P&&await async function(e,t){try{await chrome.scripting.executeScript({target:{tabId:e},files:["content/content.js"]}),await chrome.tabs.sendMessage(e,{type:"PASTE_TEXT",text:t})}catch{}}(P,o),N=!1,n.showNotifications)try{await chrome.notifications.create({type:"basic",iconUrl:"assets/icons/icon-128.png",title:"AICHE Voice-to-Text",message:"Transcription complete"})}catch{}}else await chrome.notifications.create({type:"basic",iconUrl:"assets/icons/icon-128.png",title:"AICHE Voice-to-Text",message:"No speech detected"});P=null,O=null,await $(),await V()}catch(t){if(console.error("[AICHE] Transcription failed:",t),L(t)){const t=l(),n=await f(),r=`recording-${Date.now()}.webm`,a=await async function(e,t,n,r){if(!c())throw new Error("Web Crypto API unavailable - cannot securely save offline recordings");const a=o(e),s=await i(a,n,r);return{id:`${Date.now()}-${Math.random().toString(36).substring(2,9)}`,audioData:s,filename:t,timestamp:Date.now(),retryCount:0}}(e,r,t,n),s=[...await E(),a];await k(s),await b(),(await u()).showNotifications&&await chrome.notifications.create({type:"basic",iconUrl:"assets/icons/icon-128.png",title:"AICHE Voice-to-Text",message:"Offline - recording saved for retry"})}else await chrome.notifications.create({type:"basic",iconUrl:"assets/icons/icon-128.png",title:"AICHE Voice-to-Text",message:"Transcription failed"});P=null,O=null,N=!1,await $(),await V()}}(t.buffer)}catch(e){throw console.error("[AICHE] Failed to stop recording:",e),e}}function L(e){const t=String(e).toLowerCase();return!navigator.onLine||t.includes("network")||t.includes("fetch")||t.includes("connection")||t.includes("timeout")||t.includes("econnrefused")||t.includes("enotfound")||t.includes("net::err")}async function G(){let e=await E();for(;;){const t=_(e);if(!t)return await k(S(e)),void await b();try{const n=l(),r=await f();let o;try{o=v(await s(t.audioData,n,r))}catch(n){console.error("[AICHE] Failed to decrypt queued audio:",n),e=x(e,t.id),await k(e),await b();continue}const a=await I(),i=await a.transcribeAudio(o,t.filename);if("failed"===i.status)throw new Error(i.error||"Transcription failed");const c=i.enhanced_text||i.text;if(c){const e={id:crypto.randomUUID(),text:c,timestamp:Date.now(),wordCount:i.word_count||0,language:i.language||void 0,duration:i.duration||void 0};await T(e),(await u()).showNotifications&&await chrome.notifications.create({type:"basic",iconUrl:"assets/icons/icon-128.png",title:"AICHE Voice-to-Text",message:`Saved recording processed: ${i.word_count||0} words`})}e=x(e,t.id),await k(e),await b()}catch(n){if(console.error("[AICHE] Retry failed:",n),L(n))return;const r=R(t);r.retryCount>=3?(e=x(e,t.id),await k(e),(await u()).showNotifications&&await chrome.notifications.create({type:"basic",iconUrl:"assets/icons/icon-128.png",title:"AICHE Voice-to-Text",message:"Recording failed after 3 attempts"})):(e=e.map(e=>e.id===t.id?r:e),await k(e)),await b()}}}async function V(){try{await chrome.contextMenus.removeAll(),D?chrome.contextMenus.create({id:"stop-recording",title:"Stop Recording",contexts:["editable","action"]}):chrome.contextMenus.create({id:"start-recording",title:"Record and Insert Here",contexts:["editable","action"]}),chrome.contextMenus.create({id:"separator-1",type:"separator",contexts:["editable","action"]}),chrome.contextMenus.create({id:"view-history",title:"View History",contexts:["editable","action"]})}catch(e){console.error("[AICHE] Failed to update context menu:",e)}}chrome.commands.onCommand.addListener(async e=>{if("toggle-recording"===e){const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e.id)return;D?await F():await M(e.id)}else if("open-history"===e){const e=await chrome.windows.getCurrent();e.id&&await chrome.sidePanel.open({windowId:e.id})}}),chrome.runtime.onMessage.addListener((e,t,n)=>{if("OFFSCREEN_READY"!==e.type){if("AUDIO_CHUNK"===e.type){const t=new Uint8Array(e.chunk),n=t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength);return void U.push(n)}if("RECORDING_ERROR"===e.type)return console.error("[AICHE] Recording error:",e.error),D=!1,U=[],P=null,N=!1,void((e.error.includes("dismissed")||e.error.includes("denied"))&&chrome.tabs.create({url:chrome.runtime.getURL("request-permission.html")}));if("GET_RECORDING_STATE"===e.type)return n({isRecording:D,recordingStartTime:O}),!0;if("START_RECORDING"===e.type)return e.tabId?(M(e.tabId).then(()=>n({success:!0})).catch(e=>n({success:!1,error:e.message})),!0):void 0;if("STOP_RECORDING"===e.type)return F().then(()=>n({success:!0})).catch(e=>n({success:!1,error:e.message})),!0;if("RETRY_PENDING"===e.type)return G().then(()=>n({success:!0})),!0;if("CLEAR_QUEUE"===e.type)return k([]).then(async()=>{await b(),n({success:!0})}),!0;if("AUTH_CALLBACK"===e.type){const t=new URLSearchParams(e.params),r=t.get("code")||t.get("token");if(r)return async function(e){const t=await I(),n=await async function(){const e=await u();if(e.deviceId)return e.deviceId;const t=crypto.randomUUID();return await h({deviceId:t}),t}(),r=chrome.runtime.getManifest().version,o=(await chrome.runtime.getPlatformInfo()).os,a={name:"Chrome Extension",device_fingerprint:chrome.runtime.id,device_id:n,os:o,app_version:r},i=await t.activateDeviceCode(e,a);await w(i.access_token),await y(i.refresh_token),await h({tokenExpiresAt:Date.now()+1e3*i.expires_in,userEmail:i.user.email,userId:i.user.id});const s=await t.getUserProfile();await h({isSubscribed:s.is_premium,subscriptionPlan:s.plan_name||null})}(r).then(()=>n({success:!0})).catch(e=>{console.error("[AICHE] Auth callback failed:",e),n({success:!1,error:e.message})}),!0;n({success:!1,error:"No code found"})}}else H=!0}),chrome.contextMenus.onClicked.addListener(async e=>{if("start-recording"===e.menuItemId){const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});e.id&&(await M(e.id,!0),await V())}else if("stop-recording"===e.menuItemId)await F(),await V();else if("view-history"===e.menuItemId){const e=await chrome.windows.getCurrent();e.id&&await chrome.sidePanel.open({windowId:e.id})}}),chrome.runtime.onInstalled.addListener(async e=>{"install"===e.reason&&await chrome.tabs.create({url:"https://aiche.app/connect-chrome"}),await b(),await V()}),chrome.runtime.onStartup.addListener(async()=>{await V()}),setInterval(async()=>{(await E()).length>0&&await G()},6e4),V().catch(e=>{console.error("[AICHE] Failed to initialize context menu:",e)})})();