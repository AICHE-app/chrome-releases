(()=>{"use strict";const e={encryptedAccessToken:void 0,encryptedRefreshToken:void 0,tokenStorageVersion:void 0,machineId:void 0,deviceId:void 0,accessToken:void 0,refreshToken:void 0,tokenExpiresAt:0,userEmail:"",userId:null,isSubscribed:!1,subscriptionPlan:null,autoPaste:!0,showNotifications:!0,showFloatingWidget:!0,typingSpeed:"instant",historyRetentionDays:30,themePreference:"system",hasShownWelcome:!1,hasGivenPrivacyConsent:!1,pendingTranscriptions:[],history:[]};const t="https://api.aiche.app";class n{constructor(){this.onTokenRefresh=null,this.refreshPromise=null,this.accessToken="",this.refreshToken=""}setTokens(e,t){this.accessToken=e,this.refreshToken=t}setTokenRefreshCallback(e){this.onTokenRefresh=e}async activateDeviceCode(e,n){const r=await fetch(`${t}/api/v1/auth/device/activate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:e.trim(),device_info:n})});if(!r.ok){const e=await r.json().catch(()=>({detail:"Activation failed"}));throw new Error(e.detail||"Activation failed")}const i=await r.json();return this.setTokens(i.access_token,i.refresh_token),i}async refreshAccessToken(){if(this.refreshPromise)return this.refreshPromise;this.refreshPromise=this.performTokenRefresh();try{return await this.refreshPromise}finally{this.refreshPromise=null}}async performTokenRefresh(){if(!this.refreshToken)throw new Error("No refresh token available");const e=await fetch(`${t}/api/v1/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`refresh_token=${encodeURIComponent(this.refreshToken)}`});if(!e.ok)throw new Error("Token refresh failed");const n=await e.json(),r={access_token:n.access_token,refresh_token:n.refresh_token||this.refreshToken,token_type:n.token_type||"bearer",expires_in:n.expires_in||691200};return this.setTokens(r.access_token,r.refresh_token),this.onTokenRefresh&&this.onTokenRefresh(r),r}async request(e){const t=e.headers||{};this.accessToken&&(t.Authorization=`Bearer ${this.accessToken}`);try{const n=await fetch(e.url,{method:e.method,headers:t,body:e.body});if(!n.ok){if(401===n.status&&!e.retried&&this.refreshToken)try{await this.refreshAccessToken(),t.Authorization=`Bearer ${this.accessToken}`;const n=await fetch(e.url,{method:e.method,headers:t,body:e.body});if(!n.ok)throw new Error("Session expired. Please reconnect your account.");return n.json()}catch{throw new Error("Session expired. Please reconnect your account.")}const r=await n.json().catch(()=>({detail:"Request failed"}));throw new Error(r.detail||"Request failed")}return n.json()}catch(e){throw new Error(function(e){return e instanceof Error||"object"==typeof(t=e)&&null!==t&&"message"in t&&"string"==typeof t.message?e.message:"string"==typeof e?e:"Unknown error";var t}(e))}}async getUserProfile(){return this.request({url:`${t}/api/v1/auth/me`,method:"GET"})}async transcribeAudio(e,n){const r="----AicheFormBoundary"+Math.random().toString(36).substring(2),i=`--${r}\r\nContent-Disposition: form-data; name="request"\r\nContent-Type: application/json\r\n\r\n${JSON.stringify({include_category:!1})}\r\n`,s=`--${r}\r\nContent-Disposition: form-data; name="file"; filename="${n}"\r\nContent-Type: audio/webm\r\n\r\n`,o=`\r\n--${r}--\r\n`,a=(new TextEncoder).encode(i),c=(new TextEncoder).encode(s),d=(new TextEncoder).encode(o),u=new Uint8Array(e),l=a.length+c.length+u.length+d.length,h=new Uint8Array(l);h.set(a,0),h.set(c,a.length),h.set(u,a.length+c.length),h.set(d,a.length+c.length+u.length);const m=h.buffer.slice(h.byteOffset,h.byteOffset+h.byteLength);return this.request({url:`${t}/api/v1/transcription/audio/direct`,method:"POST",headers:{"Content-Type":`multipart/form-data; boundary=${r}`},body:m})}async pollTranscriptionStatus(e,n=30){for(let r=0;r<n;r++){const n=await this.request({url:`${t}/api/v1/transcription/${e}`,method:"GET"});if("completed"===n.status||"failed"===n.status)return n;await new Promise(e=>setTimeout(e,Math.min(1e3+200*r,3e3)))}throw new Error("Transcription timed out")}async logout(){if(this.accessToken)try{await this.request({url:`${t}/api/v1/auth/logout`,method:"POST"})}catch{}this.accessToken="",this.refreshToken=""}}async function r(e,t){const n=new TextEncoder,r=await crypto.subtle.importKey("raw",n.encode(e),"PBKDF2",!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:t.buffer,iterations:1e5,hash:"SHA-256"},r,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}function i(e){const t=new Uint8Array(e);let n="";for(let e=0;e<t.byteLength;e++)n+=String.fromCharCode(t[e]);return btoa(n)}function s(e){const t=atob(e),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n}async function o(e,t,n){if(!e)throw new Error("Cannot encrypt empty token");const s=crypto.getRandomValues(new Uint8Array(16)),o=crypto.getRandomValues(new Uint8Array(12)),a=`${t}:${n}:aiche-voice`,c=await r(a,s),d=new TextEncoder;return{ciphertext:i(await crypto.subtle.encrypt({name:"AES-GCM",iv:o},c,d.encode(e))),iv:i(o.buffer),salt:i(s.buffer)}}async function a(e,t,n){if(!(e&&e.ciphertext&&e.iv&&e.salt))throw new Error("Invalid encrypted data");const i=s(e.ciphertext),o=s(e.iv),a=s(e.salt),c=`${t}:${n}:aiche-voice`,d=await r(c,a),u=await crypto.subtle.decrypt({name:"AES-GCM",iv:o.buffer},d,i.buffer);return(new TextDecoder).decode(u)}function c(){return!("undefined"==typeof crypto||!crypto.subtle||"function"!=typeof crypto.subtle.encrypt||"function"!=typeof crypto.subtle.decrypt||"function"!=typeof crypto.getRandomValues)}let d=null;async function u(){if(d)return{...d};const t=await chrome.storage.local.get("settings"),n={...e,...t.settings||{}};return d=n,n}async function l(e){const t=await u();d={...t,...e},await chrome.storage.local.set({settings:d}),d=null}function h(){return chrome.runtime.id}async function m(){const e=await u();if(e.machineId)return e.machineId;const t=crypto.randomUUID();return await l({machineId:t}),t}async function y(e){if(!c())throw new Error("Cannot save tokens - Web Crypto API unavailable");const t=h(),n=await m(),r=await o(e,t,n);await l({encryptedAccessToken:r,tokenStorageVersion:2,accessToken:void 0})}async function f(e){if(!c())throw new Error("Cannot save tokens - Web Crypto API unavailable");const t=h(),n=await m(),r=await o(e,t,n);await l({encryptedRefreshToken:r,tokenStorageVersion:2,refreshToken:void 0})}async function w(){const e=await u();if(e.encryptedAccessToken){const t=h(),n=await m();try{return await a(e.encryptedAccessToken,t,n)}catch(e){return console.error("[AICHE] Failed to decrypt access token:",e),null}}return e.accessToken?(await y(e.accessToken),e.accessToken):null}async function p(){const e=await u();if(e.encryptedRefreshToken){const t=h(),n=await m();try{return await a(e.encryptedRefreshToken,t,n)}catch(e){return console.error("[AICHE] Failed to decrypt refresh token:",e),null}}return e.refreshToken?(await f(e.refreshToken),e.refreshToken):null}async function g(){const t=await chrome.storage.local.get("settings");return{...e,...t.settings||{}}.history||[]}let T=null;let v="system",k=null,E=!1;function b(e){return"light"===e||"dark"===e||"system"===e?e:"system"}function C(e){!function(e){const t=document.documentElement;t.dataset.theme=e,t.style.colorScheme=e}(function(e){return"light"===e||"dark"===e?e:window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}(e))}const I={authView:document.getElementById("auth-view"),mainView:document.getElementById("main-view"),signInBtn:document.getElementById("sign-in-btn"),signOutBtn:document.getElementById("sign-out-btn"),settingsBtn:document.getElementById("settings-btn"),recordBtn:document.getElementById("record-btn"),viewAllBtn:document.getElementById("view-all-btn"),retryQueueBtn:document.getElementById("retry-queue-btn"),clearQueueBtn:document.getElementById("clear-queue-btn"),userEmail:document.getElementById("user-email"),historyList:document.getElementById("history-list"),queueSection:document.getElementById("queue-section"),queueCount:document.getElementById("queue-count"),recordingStatus:document.getElementById("recording-status"),recordingTime:document.getElementById("recording-time")};let S=null,L=null,R=!0,A=null,x=null,P=null;function B(){I.authView.classList.remove("hidden"),I.mainView.classList.add("hidden")}function $(e,t=null){const n=document.querySelector(".status-label");if(e)document.querySelector(".status-label").classList.remove("ready-blink"),A&&(clearInterval(A),A=null),n.textContent="REC",I.recordingStatus.classList.remove("processing"),I.recordingStatus.classList.add("active"),S=t||Date.now(),L&&clearInterval(L),L=window.setInterval(_,100),R=!1;else{if(R)return n.textContent="READY",I.recordingStatus.classList.remove("active","processing"),I.recordingTime.textContent="",S=null,R=!1,void q();n.textContent="PROCESSING",I.recordingStatus.classList.remove("active"),I.recordingStatus.classList.add("processing"),I.recordingTime.classList.add("processing-time"),L&&(clearInterval(L),L=null),setTimeout(()=>{document.querySelector(".status-label").textContent="READY",I.recordingStatus.classList.remove("processing"),I.recordingTime.classList.remove("processing-time"),I.recordingTime.textContent="",S=null,q()},2e3)}}function _(){if(!S)return;const e=Date.now()-S,t=Math.floor(e/1e3),n=Math.floor(t/60),r=t%60;I.recordingTime.textContent=`${n}:${r.toString().padStart(2,"0")}`}function q(){const e=document.querySelector(".status-label");A&&clearInterval(A);const t=()=>{e.classList.remove("ready-blink"),e.offsetWidth,e.classList.add("ready-blink")};setTimeout(()=>{t(),A=window.setInterval(t,1e4)},2e3)}async function D(){const e=(await g()).slice(0,5);if(0===e.length)return void(I.historyList.innerHTML='<p class="empty-state">No transcriptions yet</p>');const t=e.map(e=>`\n\t\t<div class="history-item" data-id="${e.id}">\n\t\t\t<div class="history-text">${function(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}(e.text)}</div>\n\t\t\t<div class="history-meta">\n\t\t\t\t${new Date(e.timestamp).toLocaleString()} · ${e.wordCount} words\n\t\t\t</div>\n\t\t</div>\n\t`).join("");I.historyList.innerHTML=t,I.historyList.querySelectorAll(".history-item").forEach(t=>{t.addEventListener("click",async()=>{const n=t.getAttribute("data-id"),r=e.find(e=>e.id===n);r&&(await navigator.clipboard.writeText(r.text),M(`Copied · ${r.wordCount||r.text.split(/\s+/).length} words`))})})}function M(e){const t=document.createElement("div");t.className="toast",t.textContent=e,document.body.appendChild(t),setTimeout(()=>t.classList.add("show"),10),setTimeout(()=>{t.classList.remove("show"),setTimeout(()=>t.remove(),300)},2e3)}async function O(){const e=function(e){let t=0,n=0,r=0;for(const i of e)Date.now()-i.timestamp>864e5?n++:i.retryCount>=3?r++:t++;return{total:e.length,pending:t,expired:n,maxRetries:r}}(await async function(){return(await u()).pendingTranscriptions||[]}());e.pending>0?(I.queueSection.classList.remove("hidden"),I.queueCount.textContent=`${e.pending} pending`):I.queueSection.classList.add("hidden")}!async function(){await async function(){const e=await u();if(v=b(e.themePreference),C(v),!k&&window.matchMedia){k=window.matchMedia("(prefers-color-scheme: dark)");const e=()=>{"system"===v&&C("system")};k.addEventListener?k.addEventListener("change",e):k.addListener(e)}E||(chrome.storage.onChanged.addListener((e,t)=>{if("local"!==t||!e.settings?.newValue)return;if(!("themePreference"in e.settings.newValue))return;const n=b(e.settings.newValue.themePreference);n!==v&&(v=n,C(v))}),E=!0)}(),await async function(){const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});e?.id&&(x=e.id,P=e.windowId??null)}(),await async function(){const e=await w(),t=await p(),r=await u();if(!e||!t)return!1;if(r.tokenExpiresAt>Date.now())return!0;try{const e=await async function(){if(T)return T;T=new n;const e=await w(),t=await p();return e&&t&&T.setTokens(e,t),T.setTokenRefreshCallback(async e=>{await y(e.access_token),await f(e.refresh_token),await l({tokenExpiresAt:Date.now()+1e3*e.expires_in})}),T}();return await e.refreshAccessToken(),!0}catch{return!1}}()?async function(){I.authView.classList.add("hidden"),I.mainView.classList.remove("hidden");const e=await async function(){const e=await u();return e.userEmail?{email:e.userEmail,isSubscribed:e.isSubscribed,subscriptionPlan:e.subscriptionPlan}:null}();e&&(I.userEmail.textContent=e.email),await D(),await O(),await async function(){const e=await chrome.runtime.sendMessage({type:"GET_RECORDING_STATE"});$(e?.isRecording||!1,e?.recordingStartTime||null)}()}():B(),function(){chrome.runtime.onMessage.addListener(e=>{"TRANSCRIPTION_COMPLETE"===e.type&&(document.querySelector(".status-label").textContent="READY",I.recordingStatus.classList.remove("processing"),I.recordingTime.classList.remove("processing-time"),I.recordingTime.textContent="",q(),e.text&&navigator.clipboard.writeText(e.text).catch(()=>{}),M(`Copied · ${e.wordCount} words`),(async()=>{await D(),await O()})())}),I.signInBtn.addEventListener("click",async()=>{await async function(){const e=chrome.runtime.getManifest(),t={name:"Chrome Extension",os:(await chrome.runtime.getPlatformInfo()).os,app_version:e.version,fingerprint:chrome.runtime.id},n=encodeURIComponent(JSON.stringify(t)),r=`chrome-extension://${chrome.runtime.id}/auth-callback.html`,i=`https://aiche.app/connect-chrome?redirect=${encodeURIComponent(r)}&device=${n}&client=chrome`;await chrome.tabs.create({url:i})}(),window.close()}),I.signOutBtn.addEventListener("click",async()=>{await async function(){if(T){try{await T.logout()}catch{}T=null}await async function(){await l({encryptedAccessToken:void 0,encryptedRefreshToken:void 0,accessToken:void 0,refreshToken:void 0,tokenExpiresAt:0,userEmail:"",userId:null,isSubscribed:!1,subscriptionPlan:null})}()}(),B()}),I.settingsBtn.addEventListener("click",()=>{chrome.runtime.openOptionsPage(),window.close()});const e=document.querySelector(".status-indicator");e&&e.addEventListener("click",async()=>{e.classList.add("ripple"),setTimeout(()=>e.classList.remove("ripple"),600);const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});t.id&&(I.recordingStatus.classList.contains("active")?($(!1),chrome.runtime.sendMessage({type:"STOP_RECORDING"})):($(!0),chrome.runtime.sendMessage({type:"START_RECORDING",tabId:t.id})))}),I.recordBtn.addEventListener("click",async()=>{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e.id)return;const t=await chrome.runtime.sendMessage({type:"GET_RECORDING_STATE"});t&&t.isRecording?(await chrome.runtime.sendMessage({type:"STOP_RECORDING"}),$(!1)):(await chrome.runtime.sendMessage({type:"START_RECORDING",tabId:e.id}),$(!0))}),I.viewAllBtn.addEventListener("click",()=>{!function(e={}){if(!chrome.sidePanel||!chrome.sidePanel.open)return void chrome.tabs.create({url:chrome.runtime.getURL("sidepanel/sidepanel.html")});const t="number"==typeof e.tabId?{tabId:e.tabId}:{windowId:"number"==typeof e.windowId?e.windowId:chrome.windows.WINDOW_ID_CURRENT};chrome.sidePanel.open(t).catch(e=>{console.error("[AICHE] Failed to open history side panel:",e)})}({tabId:x??void 0,windowId:P??void 0}),setTimeout(()=>window.close(),150)}),I.retryQueueBtn.addEventListener("click",async()=>{await chrome.runtime.sendMessage({type:"RETRY_PENDING"}),setTimeout(async()=>{await O()},100)}),I.clearQueueBtn.addEventListener("click",async()=>{I.queueSection.classList.add("hidden"),await chrome.runtime.sendMessage({type:"CLEAR_QUEUE"}),setTimeout(async()=>{await O()},200)})}(),chrome.storage.onChanged.addListener((e,t)=>{"local"===t&&e.history&&D()}),setInterval(async()=>{const e=await g(),t=I.historyList.querySelector(".history-item")?.getAttribute("data-id"),n=e[0]?.id;n&&n!==t&&await D()},500)}()})();