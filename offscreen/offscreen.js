(()=>{"use strict";let e=null,a=null;window.addEventListener("load",()=>{chrome.runtime.sendMessage({type:"OFFSCREEN_READY"})}),chrome.runtime.onMessage.addListener(r=>{"START_RECORDING"===r.type?async function(){try{e&&(e.ondataavailable=null,e.onstop=null,e.onerror=null,"inactive"!==e.state&&e.stop()),a&&(a.getTracks().forEach(e=>e.stop()),a=null),e=null,a=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:48e3,channelCount:1}});const r=MediaRecorder.isTypeSupported("audio/webm;codecs=opus")?"audio/webm;codecs=opus":"audio/webm";e=new MediaRecorder(a,{mimeType:r,audioBitsPerSecond:128e3}),e.ondataavailable=async e=>{if(e.data.size>0){const a=await e.data.arrayBuffer(),r=new Uint8Array(a),o=Array.from(r);await chrome.runtime.sendMessage({type:"AUDIO_CHUNK",chunk:o,isLast:!1})}},e.onstop=async()=>{await new Promise(e=>setTimeout(e,100)),await chrome.runtime.sendMessage({type:"RECORDING_COMPLETE"}),a&&(a.getTracks().forEach(e=>e.stop()),a=null)},e.onerror=e=>{console.error("[AICHE] MediaRecorder error:",e),chrome.runtime.sendMessage({type:"RECORDING_ERROR",error:"Recording failed"})},e.start(1e3)}catch(e){console.error("[AICHE] getUserMedia error:",e),await chrome.runtime.sendMessage({type:"RECORDING_ERROR",error:e instanceof Error?e.message:"Microphone access denied"})}}():"STOP_RECORDING"===r.type&&(e&&"inactive"!==e.state&&e.stop(),a&&(a.getTracks().forEach(e=>e.stop()),a=null))})})();